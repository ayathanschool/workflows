<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolFlow - Google Login Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 { margin-bottom: 8px; }
        h2 { margin-top: 32px; margin-bottom: 8px; color: #1a73e8; }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 13px;
        }
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }
        button:hover { background-color: #174ea6; }
        .error { color: #d93025; }
        .success { color: #188038; }
        .warning { color: #f29900; }
        .section { margin-top: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        #status { font-weight: bold; }
        .hidden { display: none; }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background-color: #f2f2f2; }
        .help-tip {
            color: #1a73e8;
            cursor: help;
            border-bottom: 1px dotted #1a73e8;
        }
        code {
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>SchoolFlow - Google Login Test</h1>
    <p>This page helps diagnose Google OAuth authentication issues by testing each step independently.</p>

    <div class="section">
        <h2>1. Configuration</h2>
        <p>Enter your Google Client ID:</p>
        <input type="text" id="clientId" placeholder="Your Google Client ID" size="60">
        <p>Enter your Google Apps Script Web App URL:</p>
        <input type="text" id="backendUrl" placeholder="https://script.google.com/macros/s/your-id/exec" size="60">
        <div>
            <button onclick="saveConfig()">Save Configuration</button>
            <button onclick="openBackendUrl()" title="Open the backend URL in a new tab to test direct access">Test URL in Browser</button>
        </div>
        <p id="configStatus"></p>
    </div>

    <div class="section">
        <h2>2. Test Google OAuth</h2>
        <p>This will test direct Google authentication without backend integration:</p>
        <button id="loginButton" onclick="testGoogleAuth()">Sign In with Google</button>
        <p id="authStatus"></p>
        <div id="tokenInfo" class="hidden">
            <h3>Token Information:</h3>
            <pre id="tokenData"></pre>
        </div>
    </div>

    <div class="section">
        <h2>3. Test Google UserInfo API</h2>
        <p>This will fetch user information using the access token:</p>
        <button id="userInfoButton" onclick="testUserInfo()" disabled>Fetch User Info</button>
        <p id="userInfoStatus"></p>
        <div id="userInfoData" class="hidden">
            <h3>User Information:</h3>
            <pre id="userInfoJson"></pre>
        </div>
    </div>

    <div class="section">
        <h2>4. Test Backend Integration</h2>
        <p>This will test sending the user info to your backend:</p>
        <button id="backendButton" onclick="testBackend()" disabled>Test Backend Login</button>
        <p id="backendStatus"></p>
        <div id="backendResponse" class="hidden">
            <h3>Backend Response:</h3>
            <pre id="backendData"></pre>
        </div>
    </div>

    <div class="section">
        <h2>5. Backend Connectivity Test</h2>
        <p>This will test direct connectivity to the backend URL:</p>
        <button id="connectivityButton" onclick="testBackendConnectivity()">Test Backend Connectivity</button>
        <p id="connectivityStatus"></p>
        <div id="connectivityResponse" class="hidden">
            <h3>Connectivity Test Results:</h3>
            <pre id="connectivityData"></pre>
        </div>
    </div>

    <div class="section">
        <h2>6. Full Login Flow</h2>
        <p>This will test the complete login flow (Google → UserInfo → Backend):</p>
        <button id="fullFlowButton" onclick="testFullFlow()">Test Full Flow</button>
        <p id="fullFlowStatus"></p>
    </div>

    <div class="section">
        <h2>Troubleshooting Results</h2>
        <table>
            <tr>
                <th>Test</th>
                <th>Status</th>
                <th>Details</th>
            </tr>
            <tr>
                <td>Google OAuth</td>
                <td id="oauthTestStatus">Not run</td>
                <td id="oauthTestDetails">-</td>
            </tr>
            <tr>
                <td>UserInfo API</td>
                <td id="userInfoTestStatus">Not run</td>
                <td id="userInfoTestDetails">-</td>
            </tr>
            <tr>
                <td>Backend Integration</td>
                <td id="backendTestStatus">Not run</td>
                <td id="backendTestDetails">-</td>
            </tr>
            <tr>
                <td>Full Flow</td>
                <td id="fullFlowTestStatus">Not run</td>
                <td id="fullFlowTestDetails">-</td>
            </tr>
            <tr>
                <td>Backend Connectivity</td>
                <td id="connectivityTestStatus">Not run</td>
                <td id="connectivityTestDetails">-</td>
            </tr>
        </table>
    </div>
    
    <div class="section">
        <h2>Common Issues & Solutions</h2>
        
        <h3>"Failed to fetch" Error</h3>
        <p>If you're seeing "TypeError: Failed to fetch" errors when testing backend connectivity, try these solutions:</p>
        <ol>
            <li><strong>Check Backend URL</strong>: Verify that the URL is correct and points to your deployed Google Apps Script web app.</li>
            <li><strong>Check Deployment Status</strong>: Make sure your Apps Script is deployed as a web app with appropriate permissions.
                <ul>
                    <li>In Google Apps Script, go to Deploy > Manage deployments</li>
                    <li>Check that your deployment is active</li>
                    <li>Verify access is set to "Anyone" or "Anyone with Google Account"</li>
                </ul>
            </li>
            <li><strong>Redeploy the Web App</strong>: Sometimes you need a fresh deployment:
                <ul>
                    <li>In Google Apps Script, go to Deploy > Manage deployments</li>
                    <li>Create a new deployment or update the existing one</li>
                    <li>Use the new Web App URL</li>
                </ul>
            </li>
            <li><strong>Check CORS Settings</strong>: Your Apps Script needs appropriate CORS headers:
                <pre>function doOptions(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');
}</pre>
            </li>
            <li><strong>Check doPost Implementation</strong>: Make sure your Apps Script has the doPost function implemented:
                <pre>function doPost(e) {
  try {
    const payload = JSON.parse(e.postData.contents);
    const action = e.parameter.action;
    
    if (action === 'googleLogin') {
      return _handleGoogleLogin(payload);
    }
    
    // Other actions...
    
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ 
      error: err.message || String(err) 
    }))
    .setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
            </li>
            <li><strong>Network Issues</strong>: Try accessing the backend URL directly in a browser to check if it's accessible.</li>
            <li><strong>Firewall/Proxy</strong>: Some networks block requests to certain domains or have proxy requirements.</li>
            <li><strong>Check Browser Console</strong>: Look for any CORS errors or network issues in the browser developer console.</li>
            <li><strong>Try a Different Browser</strong>: Sometimes issues are browser-specific.</li>
        </ol>
        
        <h3>Apps Script Deployment Checklist</h3>
        <ul>
            <li>Code has been saved (File > Save)</li>
            <li>Web app is deployed (Deploy > Manage deployments)</li>
            <li>Access is set to "Anyone" or "Anyone with Google Account"</li>
            <li>You're using the latest deployment URL</li>
            <li>Script has necessary permissions to access your spreadsheet</li>
            <li>doPost and doGet functions are correctly implemented</li>
            <li>No syntax errors in your Apps Script code</li>
        </ul>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        let accessToken = null;
        let userInfo = null;

        // Open backend URL in a new tab to test direct access
        function openBackendUrl() {
            const backendUrl = document.getElementById('backendUrl').value.trim() || 
                              localStorage.getItem('sf_test_backend_url');
            
            if (!backendUrl) {
                alert('Please enter a backend URL first');
                return;
            }
            
            // Add a ping parameter to make it clearer what we're testing
            const urlToOpen = `${backendUrl}?action=ping&test=direct`;
            window.open(urlToOpen, '_blank');
        }
        
        // Load saved configuration
        window.onload = function() {
            const savedClientId = localStorage.getItem('sf_test_client_id');
            const savedBackendUrl = localStorage.getItem('sf_test_backend_url');
            
            if (savedClientId) {
                document.getElementById('clientId').value = savedClientId;
            }
            
            if (savedBackendUrl) {
                document.getElementById('backendUrl').value = savedBackendUrl;
            }
            
            // Auto-populate from .env file if available (only works when served via HTTP)
            if (window.location.protocol !== 'file:') {
                fetch('/.env')
                    .then(response => {
                        if (!response.ok) throw new Error('Cannot access .env file');
                        return response.text();
                    })
                    .then(data => {
                        // Parse .env file
                        const lines = data.split('\n');
                        let clientId = '';
                        let backendUrl = '';
                        
                        for (const line of lines) {
                            if (line.startsWith('VITE_GOOGLE_CLIENT_ID=')) {
                                clientId = line.substring('VITE_GOOGLE_CLIENT_ID='.length).trim();
                            } else if (line.startsWith('VITE_GAS_WEB_APP_URL=')) {
                                backendUrl = line.substring('VITE_GAS_WEB_APP_URL='.length).trim();
                            }
                        }
                        
                        // Populate fields if not already set
                        if (clientId && !document.getElementById('clientId').value) {
                            document.getElementById('clientId').value = clientId;
                            localStorage.setItem('sf_test_client_id', clientId);
                        }
                        
                        if (backendUrl && !document.getElementById('backendUrl').value) {
                            document.getElementById('backendUrl').value = backendUrl;
                            localStorage.setItem('sf_test_backend_url', backendUrl);
                        }
                    })
                    .catch(err => console.log('Auto-population from .env skipped:', err.message));
            }
        };

        function saveConfig() {
            const clientId = document.getElementById('clientId').value.trim();
            const backendUrl = document.getElementById('backendUrl').value.trim();
            const configStatus = document.getElementById('configStatus');
            
            if (!clientId) {
                configStatus.textContent = 'Please enter a Google Client ID';
                configStatus.className = 'error';
                return;
            }
            
            if (!backendUrl) {
                configStatus.textContent = 'Please enter a Backend URL';
                configStatus.className = 'error';
                return;
            }
            
            localStorage.setItem('sf_test_client_id', clientId);
            localStorage.setItem('sf_test_backend_url', backendUrl);
            
            configStatus.textContent = 'Configuration saved successfully!';
            configStatus.className = 'success';
            
            // Load the Google client with the new client ID
            loadGoogleClient(clientId);
        }

        function loadGoogleClient(clientId) {
            // Remove old script if exists
            const oldScript = document.getElementById('google-client-script');
            if (oldScript) {
                document.body.removeChild(oldScript);
            }
            
            // Add new script
            const script = document.createElement('script');
            script.id = 'google-client-script';
            script.src = "https://accounts.google.com/gsi/client";
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        }

        async function testGoogleAuth() {
            const clientId = localStorage.getItem('sf_test_client_id');
            const authStatus = document.getElementById('authStatus');
            const oauthTestStatus = document.getElementById('oauthTestStatus');
            const oauthTestDetails = document.getElementById('oauthTestDetails');
            
            if (!clientId) {
                authStatus.textContent = 'Please configure your Google Client ID first';
                authStatus.className = 'error';
                oauthTestStatus.textContent = 'Failed';
                oauthTestStatus.className = 'error';
                oauthTestDetails.textContent = 'Missing Client ID';
                return;
            }
            
            try {
                authStatus.textContent = 'Initiating Google OAuth...';
                
                // Initialize Google OAuth client
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'email profile openid',
                    callback: (response) => {
                        if (response.access_token) {
                            accessToken = response.access_token;
                            
                            document.getElementById('tokenData').textContent = 
                                JSON.stringify({
                                    access_token: accessToken.substring(0, 10) + '...',
                                    token_type: response.token_type,
                                    scope: response.scope,
                                    expires_in: response.expires_in
                                }, null, 2);
                            
                            document.getElementById('tokenInfo').classList.remove('hidden');
                            document.getElementById('userInfoButton').disabled = false;
                            
                            authStatus.textContent = 'Successfully authenticated with Google!';
                            authStatus.className = 'success';
                            
                            oauthTestStatus.textContent = 'Success';
                            oauthTestStatus.className = 'success';
                            oauthTestDetails.textContent = 'Access token received';
                        } else {
                            authStatus.textContent = 'Failed to get access token';
                            authStatus.className = 'error';
                            
                            oauthTestStatus.textContent = 'Failed';
                            oauthTestStatus.className = 'error';
                            oauthTestDetails.textContent = 'No access token in response';
                        }
                    },
                    error_callback: (error) => {
                        authStatus.textContent = 'Error: ' + JSON.stringify(error);
                        authStatus.className = 'error';
                        
                        oauthTestStatus.textContent = 'Failed';
                        oauthTestStatus.className = 'error';
                        oauthTestDetails.textContent = error.toString();
                    }
                });
                
                // Request an access token
                client.requestAccessToken();
            } catch (error) {
                authStatus.textContent = 'Error: ' + error.toString();
                authStatus.className = 'error';
                
                oauthTestStatus.textContent = 'Failed';
                oauthTestStatus.className = 'error';
                oauthTestDetails.textContent = error.toString();
                console.error('Google OAuth error:', error);
            }
        }

        async function testUserInfo() {
            const userInfoStatus = document.getElementById('userInfoStatus');
            const userInfoTestStatus = document.getElementById('userInfoTestStatus');
            const userInfoTestDetails = document.getElementById('userInfoTestDetails');
            
            if (!accessToken) {
                userInfoStatus.textContent = 'No access token available. Please authenticate with Google first.';
                userInfoStatus.className = 'error';
                return;
            }
            
            try {
                userInfoStatus.textContent = 'Fetching user info...';
                
                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}: ${await response.text()}`);
                }
                
                userInfo = await response.json();
                
                document.getElementById('userInfoJson').textContent = JSON.stringify(userInfo, null, 2);
                document.getElementById('userInfoData').classList.remove('hidden');
                document.getElementById('backendButton').disabled = false;
                
                userInfoStatus.textContent = 'Successfully fetched user info!';
                userInfoStatus.className = 'success';
                
                userInfoTestStatus.textContent = 'Success';
                userInfoTestStatus.className = 'success';
                userInfoTestDetails.textContent = `Retrieved info for ${userInfo.email}`;
            } catch (error) {
                userInfoStatus.textContent = 'Error: ' + error.toString();
                userInfoStatus.className = 'error';
                
                userInfoTestStatus.textContent = 'Failed';
                userInfoTestStatus.className = 'error';
                userInfoTestDetails.textContent = error.toString();
                console.error('UserInfo API error:', error);
            }
        }

        async function testBackend() {
            const backendUrl = localStorage.getItem('sf_test_backend_url');
            const backendStatus = document.getElementById('backendStatus');
            const backendTestStatus = document.getElementById('backendTestStatus');
            const backendTestDetails = document.getElementById('backendTestDetails');
            
            if (!backendUrl) {
                backendStatus.textContent = 'Please configure your Backend URL first';
                backendStatus.className = 'error';
                return;
            }
            
            if (!userInfo) {
                backendStatus.textContent = 'No user info available. Please fetch user info first.';
                backendStatus.className = 'error';
                return;
            }
            
            try {
                // Display debugging info
                backendStatus.textContent = `Sending request to: ${backendUrl}?action=googleLogin`;
                console.log('Backend URL:', backendUrl);
                console.log('Backend test started at:', new Date().toISOString());
                
                // Create payload
                const payload = {
                    google_id: userInfo.sub,
                    email: userInfo.email,
                    name: userInfo.name,
                    picture: userInfo.picture,
                    access_token: accessToken
                };
                
                console.log('Payload being sent:', {...payload, access_token: '(truncated)'});
                
                // Attempt to ping the backend first
                try {
                    backendStatus.textContent = 'Testing CORS with OPTIONS request...';
                    const pingResponse = await fetch(`${backendUrl}?action=ping`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (pingResponse.ok) {
                        console.log('Ping successful, CORS appears to be configured correctly');
                        backendStatus.textContent = 'CORS check passed. Sending user info to backend...';
                    } else {
                        console.warn('Ping failed with status:', pingResponse.status);
                        backendStatus.textContent = `CORS check: Status ${pingResponse.status}. Attempting login anyway...`;
                    }
                } catch (pingError) {
                    console.error('Ping test failed:', pingError);
                    backendStatus.textContent = 'CORS check failed. Attempting login anyway...';
                }
                
                // Attempt POST request
                try {
                    const response = await fetch(`${backendUrl}?action=googleLogin`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        // Try GET fallback if POST fails with 404
                        if (response.status === 404) {
                            console.log('POST request failed with 404, trying GET fallback...');
                            backendStatus.textContent = 'POST request failed with 404, trying GET fallback...';
                            
                            const getFallbackUrl = `${backendUrl}?action=googleLogin&email=${encodeURIComponent(userInfo.email)}`;
                            console.log('GET fallback URL:', getFallbackUrl);
                            
                            const fallbackResponse = await fetch(getFallbackUrl);
                            
                            if (!fallbackResponse.ok) {
                                throw new Error(`GET fallback failed: HTTP error ${fallbackResponse.status}: ${await fallbackResponse.text()}`);
                            }
                            
                            const backendData = await fallbackResponse.json();
                            document.getElementById('backendData').textContent = JSON.stringify(backendData, null, 2);
                            document.getElementById('backendResponse').classList.remove('hidden');
                            
                            backendStatus.textContent = 'Successfully authenticated with backend using GET fallback!';
                            backendStatus.className = 'success';
                            
                            backendTestStatus.textContent = 'Success (GET fallback)';
                            backendTestStatus.className = 'success';
                            backendTestDetails.textContent = `User: ${backendData.email}, Roles: ${backendData.roles || 'none'}`;
                            return;
                        }
                        throw new Error(`HTTP error ${response.status}: ${await response.text()}`);
                    }
                
                const backendData = await response.json();
                document.getElementById('backendData').textContent = JSON.stringify(backendData, null, 2);
                document.getElementById('backendResponse').classList.remove('hidden');
                
                backendStatus.textContent = 'Successfully authenticated with backend!';
                backendStatus.className = 'success';
                
                backendTestStatus.textContent = 'Success';
                backendTestStatus.className = 'success';
                backendTestDetails.textContent = `User: ${backendData.email}, Roles: ${backendData.roles || 'none'}`;
                
                } catch (postError) {
                    console.error('POST request failed:', postError);
                    backendStatus.textContent = 'POST method failed. Details in console.';
                    
                    // Try direct GET method as last resort
                    try {
                        backendStatus.textContent = 'Trying direct GET method as last resort...';
                        const directGetUrl = `${backendUrl}?action=googleLogin&email=${encodeURIComponent(userInfo.email)}`;
                        const directGetResponse = await fetch(directGetUrl);
                        
                        if (!directGetResponse.ok) {
                            throw new Error(`Direct GET failed: ${directGetResponse.status}`);
                        }
                        
                        const getData = await directGetResponse.json();
                        document.getElementById('backendData').textContent = JSON.stringify(getData, null, 2);
                        document.getElementById('backendResponse').classList.remove('hidden');
                        
                        backendStatus.textContent = 'Successfully authenticated with direct GET method!';
                        backendStatus.className = 'success';
                        
                        backendTestStatus.textContent = 'Success (Direct GET)';
                        backendTestStatus.className = 'success';
                        backendTestDetails.textContent = `User: ${getData.email}, Roles: ${getData.roles || 'none'}`;
                        return;
                    } catch (getError) {
                        console.error('Direct GET also failed:', getError);
                        throw new Error(`All methods failed: POST: ${postError.message}, GET: ${getError.message}`);
                    }
                }
            } catch (error) {
                backendStatus.textContent = 'Error: ' + error.toString();
                backendStatus.className = 'error';
                
                // Add backend URL to the error details for debugging
                const errorWithUrl = `${error.toString()} (URL: ${backendUrl})`;
                
                backendTestStatus.textContent = 'Failed';
                backendTestStatus.className = 'error';
                backendTestDetails.textContent = errorWithUrl;
                
                console.error('Backend integration error:', error);
                console.log('Backend URL that failed:', backendUrl);
                
                // Show detailed network troubleshooting section
                const backendResponse = document.getElementById('backendResponse');
                backendResponse.classList.remove('hidden');
                document.getElementById('backendData').innerHTML = 
                    `<h4>Troubleshooting Steps:</h4>
                    <ol>
                        <li>Check if the URL is correct: <code>${backendUrl}</code></li>
                        <li>Verify your Apps Script deployment is published as a web app</li>
                        <li>Check if the web app is accessible to "Anyone" or "Anyone with Google Account"</li>
                        <li>Make sure the Apps Script has the doPost function implemented</li>
                        <li>Try opening the backend URL directly in a new tab to check for errors</li>
                        <li>Check Apps Script logs for any backend errors</li>
                        <li>Verify there are no network issues or firewalls blocking the request</li>
                    </ol>`;
            }
        }

        async function testBackendConnectivity() {
            const backendUrl = localStorage.getItem('sf_test_backend_url');
            const connectivityStatus = document.getElementById('connectivityStatus');
            const connectivityTestStatus = document.getElementById('connectivityTestStatus');
            const connectivityTestDetails = document.getElementById('connectivityTestDetails');
            const connectivityData = document.getElementById('connectivityData');
            const connectivityResponse = document.getElementById('connectivityResponse');
            
            if (!backendUrl) {
                connectivityStatus.textContent = 'Please configure your Backend URL first';
                connectivityStatus.className = 'error';
                connectivityTestStatus.textContent = 'Failed';
                connectivityTestStatus.className = 'error';
                connectivityTestDetails.textContent = 'Backend URL not configured';
                return;
            }
            
            connectivityStatus.textContent = 'Testing connectivity to backend...';
            connectivityTestStatus.textContent = 'Running...';
            
            const results = [];
            
            // Test 1: Basic CORS preflight test
            try {
                results.push('1. Testing CORS preflight (OPTIONS request)...');
                const corsTestResponse = await fetch(backendUrl, {
                    method: 'OPTIONS',
                    mode: 'cors'
                });
                
                results.push(`   Result: ${corsTestResponse.status} ${corsTestResponse.statusText}`);
                if (corsTestResponse.ok) {
                    results.push('   ✓ CORS preflight successful');
                } else {
                    results.push('   ⚠ CORS preflight returned non-success status');
                }
                
                // Log headers
                results.push('   Headers:');
                corsTestResponse.headers.forEach((value, key) => {
                    results.push(`     - ${key}: ${value}`);
                });
            } catch (error) {
                results.push(`   ✗ CORS preflight error: ${error.message}`);
            }
            
            // Test 2: Simple ping
            try {
                results.push('\n2. Testing simple ping (GET request)...');
                const pingUrl = `${backendUrl}?action=ping`;
                results.push(`   URL: ${pingUrl}`);
                
                const pingResponse = await fetch(pingUrl, { 
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                results.push(`   Status: ${pingResponse.status} ${pingResponse.statusText}`);
                
                if (pingResponse.ok) {
                    const pingData = await pingResponse.text();
                    results.push(`   Response: ${pingData}`);
                    results.push('   ✓ Ping successful');
                } else {
                    results.push(`   ⚠ Ping returned non-success status`);
                }
            } catch (error) {
                results.push(`   ✗ Ping error: ${error.message}`);
            }
            
            // Test 3: POST capability
            try {
                results.push('\n3. Testing POST capability...');
                const testData = { test: 'connectivity', timestamp: Date.now() };
                
                const postResponse = await fetch(`${backendUrl}?action=ping`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                results.push(`   Status: ${postResponse.status} ${postResponse.statusText}`);
                
                if (postResponse.ok) {
                    const postData = await postResponse.text();
                    results.push(`   Response: ${postData}`);
                    results.push('   ✓ POST request successful');
                } else if (postResponse.status === 404) {
                    results.push('   ⚠ POST returned 404 - doPost handler might be missing in Apps Script');
                } else {
                    results.push(`   ⚠ POST returned non-success status`);
                }
            } catch (error) {
                results.push(`   ✗ POST error: ${error.message}`);
            }
            
            // Test 4: DNS lookup via fetch API
            try {
                results.push('\n4. Testing DNS resolution...');
                const urlObj = new URL(backendUrl);
                const hostname = urlObj.hostname;
                results.push(`   Hostname: ${hostname}`);
                
                const dnsTestResponse = await fetch(`https://${hostname}/generate_204`, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                
                results.push(`   ✓ DNS resolution successful`);
            } catch (error) {
                results.push(`   ✗ DNS resolution error: ${error.message}`);
            }
            
            // Display results
            connectivityData.textContent = results.join('\n');
            connectivityResponse.classList.remove('hidden');
            
            // Determine overall status
            const success = results.some(line => line.includes('✓'));
            const failure = results.some(line => line.includes('✗'));
            
            if (success && !failure) {
                connectivityStatus.textContent = 'All connectivity tests passed!';
                connectivityStatus.className = 'success';
                connectivityTestStatus.textContent = 'Success';
                connectivityTestStatus.className = 'success';
                connectivityTestDetails.textContent = 'Backend is accessible';
            } else if (success) {
                connectivityStatus.textContent = 'Some connectivity tests passed with warnings';
                connectivityStatus.className = 'warning';
                connectivityTestStatus.textContent = 'Partial';
                connectivityTestStatus.className = 'warning';
                connectivityTestDetails.textContent = 'See detailed results';
            } else {
                connectivityStatus.textContent = 'Connectivity tests failed';
                connectivityStatus.className = 'error';
                connectivityTestStatus.textContent = 'Failed';
                connectivityTestStatus.className = 'error';
                connectivityTestDetails.textContent = 'Backend not accessible';
                
                // Add troubleshooting suggestions
                connectivityData.innerHTML += '\n\n=== Troubleshooting Suggestions ===\n' +
                    '1. Check if the backend URL is correct\n' +
                    '2. Verify that the Apps Script web app is deployed and published\n' +
                    '3. Check that the web app\'s access is set to "Anyone" or "Anyone with Google Account"\n' +
                    '4. Make sure you\'re using the latest deployment URL (after redeployment)\n' +
                    '5. Check if there are any network restrictions or firewalls blocking the connection\n' +
                    '6. Try accessing the backend URL directly in a new browser tab\n' +
                    '7. Look at Apps Script logs for any backend errors';
            }
        }
        
        async function testFullFlow() {
            const clientId = localStorage.getItem('sf_test_client_id');
            const backendUrl = localStorage.getItem('sf_test_backend_url');
            const fullFlowStatus = document.getElementById('fullFlowStatus');
            const fullFlowTestStatus = document.getElementById('fullFlowTestStatus');
            const fullFlowTestDetails = document.getElementById('fullFlowTestDetails');
            
            // Display current environment info for debugging
            console.log('Full flow test - Environment information:');
            console.log('- Client ID:', clientId ? (clientId.substring(0, 12) + '...') : 'Not set');
            console.log('- Backend URL:', backendUrl || 'Not set');
            console.log('- Browser:', navigator.userAgent);
            console.log('- Date/Time:', new Date().toISOString());
            
            if (!clientId || !backendUrl) {
                fullFlowStatus.textContent = 'Please configure your Google Client ID and Backend URL first';
                fullFlowStatus.className = 'error';
                return;
            }
            
            try {
                fullFlowStatus.textContent = 'Initiating full authentication flow...';
                
                // Step 1: Google OAuth
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'email profile openid',
                    callback: async (response) => {
                        if (!response.access_token) {
                            throw new Error('Failed to get access token from Google');
                        }
                        
                        const token = response.access_token;
                        fullFlowStatus.textContent = 'Received access token, fetching user info...';
                        
                        // Step 2: Get user info
                        const userInfoResponse = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        
                        if (!userInfoResponse.ok) {
                            throw new Error(`Failed to get user info: HTTP ${userInfoResponse.status}`);
                        }
                        
                        const userInfo = await userInfoResponse.json();
                        fullFlowStatus.textContent = 'Received user info, authenticating with backend...';
                        
                        // Step 3: Authenticate with backend
                        const payload = {
                            google_id: userInfo.sub,
                            email: userInfo.email,
                            name: userInfo.name,
                            picture: userInfo.picture,
                            access_token: token
                        };
                        
                        try {
                            console.log('Attempting POST request to backend');
                            fullFlowStatus.textContent = 'Testing connection to backend...';
                            
                            // Try ping first to check if backend is accessible
                            try {
                                fullFlowStatus.textContent = 'Pinging backend...';
                                const pingUrl = `${backendUrl}?action=ping`;
                                console.log('Ping URL:', pingUrl);
                                
                                const pingResponse = await fetch(pingUrl);
                                if (pingResponse.ok) {
                                    console.log('Ping successful:', await pingResponse.text());
                                    fullFlowStatus.textContent = 'Backend is responsive. Attempting authentication...';
                                } else {
                                    console.warn('Ping failed with status:', pingResponse.status);
                                    fullFlowStatus.textContent = 'Warning: Backend ping failed. Will try login anyway...';
                                }
                            } catch (pingErr) {
                                console.error('Ping error:', pingErr);
                                fullFlowStatus.textContent = 'Warning: Backend ping failed. Will try login anyway...';
                            }
                            
                            // Try POST first
                            fullFlowStatus.textContent = 'Sending POST request to backend...';
                            const backendResponse = await fetch(`${backendUrl}?action=googleLogin`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(payload)
                            });
                            
                            if (!backendResponse.ok) {
                                console.log('POST response not OK:', backendResponse.status);
                                
                                if (backendResponse.status === 404) {
                                    // Try GET fallback
                                    fullFlowStatus.textContent = 'POST failed with 404, trying GET fallback...';
                                    console.log('Attempting GET fallback');
                                    
                                    const getFallbackUrl = `${backendUrl}?action=googleLogin&email=${encodeURIComponent(userInfo.email)}`;
                                    console.log('GET fallback URL:', getFallbackUrl);
                                    
                                    const fallbackResponse = await fetch(getFallbackUrl);
                                    
                                    if (!fallbackResponse.ok) {
                                        console.error('GET fallback failed:', fallbackResponse.status);
                                        const responseText = await fallbackResponse.text();
                                        console.error('Response text:', responseText);
                                        throw new Error(`GET fallback failed: HTTP ${fallbackResponse.status} - ${responseText}`);
                                    }
                                    
                                    const userData = await fallbackResponse.json();
                                    console.log('GET fallback success:', userData);
                                    fullFlowStatus.textContent = 'Successfully completed full authentication flow using GET fallback!';
                                    fullFlowStatus.className = 'success';
                                    
                                    fullFlowTestStatus.textContent = 'Success (GET fallback)';
                                    fullFlowTestStatus.className = 'success';
                                    fullFlowTestDetails.textContent = `User: ${userData.email}, Roles: ${userData.roles || 'none'}`;
                                    return;
                                }
                                
                                // Try to get response text for better error reporting
                                const errorText = await backendResponse.text().catch(e => 'Could not read response body');
                                console.error('Backend error response:', errorText);
                                throw new Error(`Backend POST failed: HTTP ${backendResponse.status} - ${errorText}`);
                            }
                            
                            const userData = await backendResponse.json();
                            console.log('Backend authentication successful:', userData);
                            fullFlowStatus.textContent = 'Successfully completed full authentication flow!';
                            fullFlowStatus.className = 'success';
                            
                            fullFlowTestStatus.textContent = 'Success';
                            fullFlowTestStatus.className = 'success';
                            fullFlowTestDetails.textContent = `User: ${userData.email}, Roles: ${userData.roles || 'none'}`;
                        } catch (error) {
                            console.error('Backend integration error:', error);
                            throw new Error(`Backend integration failed: ${error.message}`);
                        }
                    },
                    error_callback: (error) => {
                        fullFlowStatus.textContent = 'Google OAuth error: ' + JSON.stringify(error);
                        fullFlowStatus.className = 'error';
                        
                        fullFlowTestStatus.textContent = 'Failed';
                        fullFlowTestStatus.className = 'error';
                        fullFlowTestDetails.textContent = 'Google OAuth failed';
                        console.error('Google OAuth error:', error);
                    }
                });
                
                // Request an access token
                client.requestAccessToken();
            } catch (error) {
                fullFlowStatus.textContent = 'Error: ' + error.toString();
                fullFlowStatus.className = 'error';
                
                fullFlowTestStatus.textContent = 'Failed';
                fullFlowTestStatus.className = 'error';
                fullFlowTestDetails.textContent = error.toString();
                console.error('Full flow error:', error);
            }
        }
    </script>
</body>
</html>